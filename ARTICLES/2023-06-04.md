# 2023-06-04

＊＊＊さん、こんにちは。

こんにちは
完全に遅刻しました、私のミスです

Win32/Win64に関して、若干補足する。

Win32では_WIN32マクロがコンパイラによって定義済みとなる。
Win64では_WIN64マクロがコンパイラによって定義済みとなるが、互換性のため_WIN32も定義されている。
Win32ではsizeof(void*)は4バイトだった。Win64では8バイトになった。
Win64で8バイトの整数を記述するために、後ろに「_PTR」が付いた整数型が定義された（LONG_PTR、INT_PTR、UINT_PTRなど）。
Win32とWin64の相互運用性のために、ダイアログプロシージャの戻り値はINTからINT_PTRに変更された。
また、ポインタをメッセージとして渡せるように、WPARAMやLPARAMはWin64では64ビット整数になった。
Win32のGet/SetWindowLongはWin64ではSetWindowLongPtrとなり、さらにGet/SetWindowLongPtrがWin32で使えるようになった。
Win64で追加された新しい64ビット整数型はWin32でも32ビット整数として使用可能となっている。
標準C/C++ではsize_tやintptr_tが使用できる。C言語のstrlen関数の戻り値の型はsize_tであることに注意する。size_tは符号なしだから、符号付きの整数と比較するといろいろまずい。

Win32とオブジェクト指向について。ウィンドウを扱うなら、C++のクラスやポインタを活用すると便利だ。
ウィンドウハンドルに対してポインタを関連付けたい場合、次のような手法を使うことができる。

CreateWindow[Ex]関数の最後の引数はポインタであり、ここに関連付けたいオブジェクトを指定すると
WM_CREATEの((LPCREATESTRUCT)lParam)->lpCreateParamsにより渡される。
これをSetWindowLongPtrのGWLP_USERDATAにセットするとウィンドウハンドルとポインタの関連付けを行うことができる。
それ以降は、ウィンドウハンドルからGetWindowLongPtrのGWLP_USERDATAを使ってオブジェクトを取得できる。
ただし、SetWindowLongPtrでポインタをセットするには、ポインタからLONG_PTRへの型キャストが必要だ。

DialogBoxParamやCreateDialogParam関数の最後の引数はLPARAMであり、ここに関連付けたいオブジェクトを指定するとWM_INITDIALOGのlParamにより渡される。これをSetWindowLongPtrのDWLP_USERにセットするとウィンドウハンドルとオブジェクトの関連付けを行うことができる。
それ以降は、ウィンドウハンドルからGetWindowLongPtrのDWLP_USERを使ってオブジェクトを取得できる。ただし、ポインタを整数のLPARAMに変換するには型キャストが必要だ。

グローバル変数を使用するとコード品質が低くなるので、グローバル変数を減らすためにこのようなテクニックを使用する。

- https://github.com/katahiromz/XWordGiver/blob/master/XG_Window.cpp

このページのXG_Window::WindowProcを参照。

さて、実際に中規模以上のWin32プロジェクトを作るのであれば、大抵MFC、ATL/WTLなどのクラスライブラリを使用することになる。
自分ですべて作成したいという協調性のないわがままな人は、私のように時間を浪費してしまうだろう。
MFCは古いのでレガシー開発に限られる。新規開発ではATL/WTLを推奨する。ATL/WTLでの開発手法については信頼できる一次資料を当たってほしい。

さて今後の対応について話そう。当初、日本語入力研究課の設置にあたって、次の３つの目標を立てた。

- 目標1. Win32のIMM/IMEの仕組みを明らかにすること。
- 目標2. Win32ソフトウェア開発およびSREの技能を獲得すること。
- 目標3. WinXPまたはそれに相当するOSを一般に利用可能にすること。

さて、目標1は80%到達した。目標2は獲得できている。目標3は、第三者によってWinXPのアクティベーションがハックされ、セキュリティパッチが書けるほど解析済みとなった。よって３つの目標はほぼ達成されたと言える。今日を以って日本語入力研究課は解散する。

【辞令】日本語入力研究課は今日を以って解散とする。合同会社イナホメゼル 代表 片山博文MZ

Vistaのセキュリティレベルに到達するには、ReactOSが一度、商業的に成功しないといけない。
私はReactOSの開発を続ける。

わかりました
少し寂しいですが...

質問はありますか？

特にありません

お疲れ様でした

今までありがとうございました

---

[戻る](2023-05-14.md)
