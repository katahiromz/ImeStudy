# 2022-03-19

それでは始めます。

今、サクラエディタ使っているけど、「秀丸エディタを使わないと雇わない」という職場もある。
そういうときは代わりに秀丸エディタを使うか、独占禁止法で訴えて下さい。

## 解析について

さてさて、Windowsのことを詳しく知って何の役に立つのか。プログラムがどういう風に動いているかがわかる。いわゆるプログラムの解析というやつです。
解析の道を究めると、ITセキュリティ関係の会社でセキュリティアナリストにはなれるかもしれない（※ただし都内在住の有名大学卒に限る）。
ゲーム解析屋とかハッカーという道もある。

パソコンのCPUは機械語で動いている。人間には機械語は単なるバイナリデータにしか見えない。バイナリデータは、いわば16進数の並び、言い換えればバイト列（bytes）として表せる。バイト列の機械語を人間に分かりやすくしたのがアセンブリだ。
例えば、機械語の「66 89 D8」はアセンブリの「mov eax, ebx」であり、これは「ebxレジスタの内容をeaxレジスタにコピーする」という意味がある。
アセンブリを機械語に直すのがアセンブラである。これは普通のコンパイラが行っている処理である。
その逆向きの処理を下界では「逆汗」という。逆汗は特に解析で行われる処理だ。
アセンブリ／アセンブラのことは asm と略する。今回ターゲットのCPUはx86だからx86 asmを使うことになる。
下界では使ってはいけない言葉があるから、気を付けるように。
分からないx86 asmがあれば、例えば「x86 asm mov」などとウェブ検索すればmovの解説が見つかる。

## 解析の準備

https://www.nasm.us/ ここからNASMの最新版（2.15.05）をダウンロードせよ。NASMの中に「nasm.exe」と「ndisasm.exe」というのがある。これをどこか（例えばc:\dev\binなど）に置いて環境変数PATHを通す。

https://www.vector.co.jp/soft/win95/util/se079072.html ここからバイナリエディタのStirling（スターリング）をダウンロード＆インストールせよ。これを使えばバイナリファイルを操れる。

ndisasmを使えばバイナリデータを逆汗できるし、nasmを使えばアセンブリを機械語に直すことができる。

## Win2k3 デバッグ

今回は、Win2k3をデバッグする。テキストは手引きの「Win2003評価版のデバッグ方法」。
https://katahiromz.web.fc2.com/reactos/tebiki.html
Win2k3 評価版を
https://www.microsoft.com/en-us/download/details.aspx?id=19727
からダウンロードする。評価版は期限切れのため、VirtualBoxにインストールする前に、システム日時を変更する必要がある。
システム時刻の同期を解除して、2005-01-01 00:00に設定。付属文書にパスワードが書かれているからそれをメモしておく。
仮想マシンの現在の状態を保存するには「仮想マシン」の「スナップショット」という機能を使う。
以降、Win2k3の仮想マシンを操作する前には、必ずシステム日時を2005-01-01に設定すること。
ただし、ソースファイルなどを操作する場合はWin2k3の操作をやめてファイルの日時が壊れないようにシステム日時を同期して元に戻すこと。
仮想マシンにおいてCtrl+Alt+Deleteは特殊なキーなのでVirtualBoxのメニューから入力する。

【課題1】テキスト通りにWinDBGを使ってWin2k3のSHELL32!SHFileOperationWを調べてみよう。
マウスポインタが見えないときは、「入力」の「マウス統合」を無効にして下さい。

## プロセス、スレッド、モジュール

OSにおけるいくつかの概念について説明する。WindowsはOS（基本ソフト）であり、OS（Operating System）はプロセス（process）という単位でプログラムを動かす。Windowsはマルチタスクであり、複数のプロセスが同時に動作している。
プロセスの中にはさらに小さい実行単位のスレッド（thread）というのが1個以上ある。それぞれのスレッドは並列に動作する。
１つのプロセスで主な処理を行うスレッドをメインスレッド（main thread）という。
プロセスはアドレス空間にいくつかのモジュール（module）を保持する。

ここではモジュールというのは、WindowsではEXEかDLLであり、「MZ」で始まるバイナリデータである。
実際、EXE/DLLをバイナリエディタで開くと「MZ」で始まることが確認できる。
EXEはそのまま実行可能なプログラム（executable）だ。
DLLは他のモジュールから読み込んで使えるライブラリ（dynamic linked library）である。
ライブラリというのは、C言語で言うところの関数の集まりである。
inlineではない関数は、モジュールの中のどこかのアドレス空間にバイナリデータとして横たわっていて、アドレスをたどって逆汗すれば、解析が可能だ。

EXE/DLLファイルには機械語以外のデータも含まれていて、そのままでは解析は難しい。
そこで動的解析では、実際にターゲットのプログラムを動かして確認する。実際に動かすことで実際のアドレス空間が再現され、解析が楽になる。
君には動的解析をマスターしてもらおう。
日本語入力で重要なモジュールは「imm32.dll」「user32.dll」「win32k.sys」の３つだ。まずはimm32を解析しよう。

## 実習 imm32の解析

Win32でDLLを使う場合は、使いたい関数を宣言するヘッダーファイルを#includeして、必要なライブラリをリンクする。例えばImmReleaseContextという関数を使う場合、#include <imm.h>でインクルードして-limm32でリンクする訳だ。リンクしたDLLはプログラムの起動時に読み込まれる。DLLの読み込みのタイミングを細かく制御したい場合は、LoadLibrary/GetProcAddress/FreeLibraryを使う。

【課題2】
`ImeStudy/ARTICLES`のhello11をビルドし、このプログラムhello11.exeとWinDBGを使ってWin2k3上でimm32!ImmReleaseContextを解析する。

1. imm32.dllのImmReleaseContext関数にブレークポイントを設定して停止させ、逆汗を吐かせよ。
2. バックトレース（関数の呼び出し履歴; backtrace）を吐かせよ。
3. hello11で指定されている実引数の0xBEEFCAFEを発見せよ。

※それぞれの証拠（evidence）を画像として保存すること。

今日はここまで。課題が出来たら報告してくれ。

---

[戻る](2022-03-17.md) | [次へ](2022-03-20.md)
