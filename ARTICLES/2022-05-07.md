# 2022-05-07

こんにちわっす。

こんにちは。

## 静的解析について

今回は「静的解析」について勉強するよ。以前はWinDBGやKDBで動的解析を行いました。
今度は解析対象を実行しないで解析する「静的解析」を行います。
動的解析と静的解析を組み合わせることでより詳しく分析できます。
これを極めると、未知のプログラムを解析できるセキュリティエンジニアになれるかも。

まずは、2k3のC:\Windows\system32から
kernel32.dll、user32.dll、imm32.dll、intl.cpl、win32k.sysを
VirtualBoxの共有フォルダ経由でローカルにコピーして下さい。

解析対象のファイルのことを「検体」と言います。

## Ghidraの紹介

アメリカの情報機関、国家安全保障局（NSA）がGhidra（ギドラ）というソフトを公開している。
これがおそらく無料で出来る最高峰の逆工学ソフトだと思われる。

## 実習 Ghidra

「NSA Ghidra」で検索して最新版のGhidraをダウンロード＆展開して適当な場所に置く。
中のghidraRun.batをダブルクリック。

[File] --> [New Project]を選ぶ。
[Non-Shared Project]を選んで[Next]。
[Project Directory]に適当な場所を指定。
[Project Name]に検体の名前を入力して[Finish]。

[Flie] --> [Import File...]を選ぶ。検体を取り込む。[OK]を押す。
[Import Results Summary]が表示されたら何とかして閉じる。
検体の名前の項目をダブルクリックしてプロジェクトを開いて下さい。
[Would you like to analyze it now?]で[No]をクリック。
[File] --> [Load PDB File...]を選んでシンボルファイル（*.pdb）を取り込む。

WinDBGで取り込んだシンボル情報は以前の動的解析で読み込まれて
%PROGRAMDATA%\Dbg (C:\ProgramData\Dbg)
にあるはずだ。検体に対応する*.pdbファイルを指定する。停止するまでしばらく待つ。

[Analysis] --> [Auto Analysis ...]を選ぶ。[Analyze]をクリック。
自動解析が始まる。停止するまでしばらく待つ。
解析が終わったら、左側の[Symbol Tree]に[Functions]と[Symbols]がある。
これを展開して項目をダブルクリックすると中央の[Listing]に逆汗、右側の[Dec*mpile]に逆コンパが表示される。

左下に[Data Type Manager]というのがある。これは型情報です。
現在読み込まれている型情報がここに表示されます。
ここで[New]で新たな構造体型を定義できます。

関数の解析結果にあるundefined...という型は解析器が判別できなかった型です。
これを右クリックして「Retype Variable」を選び、定義済みの型を指定すれば、さらに解析が詳しくなります。
変数名を右クリックして「Rename Variable」を選べば変数の名前を分かりやすく変えることができます。

また、関数プロトタイプを右クリックして、「Edit Function Signature」を選べば、
関数のCalling Convention（呼び出し規約）などを変更できます。
また、関数呼び出しの関数名をダブルクリックすると、その関数にジャンプできます。

型情報の追加を繰り返していくことで解析がより正確になります。
最後にプロジェクトを「保存」して下さい。

## 注意

最初の解析結果が必ず正しいとは言えません。解析結果はあくまで推測です。
変数の型が違う。関数の呼び出し規約が違う。関数の引数の個数が違う。
戻り値の有無が違う。このような場合では解析結果は正しいとは言えません。

なお、日本国内では、逆工学している、逆工学できるなどと公言したり、
解析内容を一般に公開すると、詰みになるかもしれないから気を付けて下さい。
これは、本当に危険な技術ですので、そこの所、よろしくお願いします。

今日はここまで。

## 逆工学の危険性

それほど危険なのはなぜなのでしょうか
いまいち想像がついていません

大企業に損害を及ぼす可能性があるという意味です。

なるほど
基本的にはその部分だけなんですかね?

就職にも影響する恐れもあります。

そこまで大きく出るんですか...
そこまでは想定外でした

## 課題について

課題はどうでした？

なかなか苦戦しています
IMEのインストールはできたのですが、そことImmInstallIMEWが結びついていません
インストールしてもその関数が呼び出された表示が出ないんですよね

でしたらImmInstallIMEWはユーザモードだから、ImmInstallIMEW内部にDebugBreak();を仕掛ければよいかと。

なるほど!
そういう手があるんですね
もうすこしいろいろ試してみる必要がありそうです...

ありがとうございました。

ありがとうございました!

---

[戻る](2022-04-23.md) | [次へ](2022-05-08.md)
